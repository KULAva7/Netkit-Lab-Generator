<!DOCTYPE html>
<!-- versione 2.0 -->
<html>
<head>
    <title>Netkit Lab Generator</title>

    <script src="js/jquery-2.1.4.min.js"></script>
    <script>window.jQuery || document.write('<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"><\/script>');</script>

    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <script>
        if (!$("link[href='/css/bootstrap.min.css']").length)
            document.write('<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" integrity="sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ==" crossorigin="anonymous" \/>');
    </script>

    <style>
        body {
            background: white;
            padding: 10px;
        }
        .hidden {
            display: none;
            visibility: hidden;
            opacity: 0;
        }
        .btn {
            margin: 2px 0;
            padding: 4px 3px;
            border-radius: 0;
        }
        input {
            border-radius: 0;
        }
        table {
            border-collapse: separate; border-spacing: 0 2px; box-sizing: border-box;
        }
        tr td:first-child, tr th:first-child { border-bottom-left-radius: 1px; border-top-left-radius: 1px; }
        tr td:last-child, tr th:last-child { border-bottom-right-radius: 1px; border-top-right-radius: 1px; }
        tr {
            background-color: rgba(0, 0, 0, 0.01);

        }
        td, th {
            border: solid 1px #aaa;
            border: solid 1px rgba(0, 0, 0, 0.2);
            padding: 10px;
        }
        strong {
            font-size: 120%;
            padding: 0 5px;
        }

    </style>

    <script>

        var nameservers = [];

        function addInterface(obj) {
            var id = obj.id.substring(3);
            addInterfaceId(id);
        }

        function addGateway(obj) {
            var id = obj.id.substring(3);
            var childs = $("#"+id+" input.gw").length;
            $("#"+id).append('<label>Route:</label>'+
                    '<input type="text" class="route"><br />'+
                    '<label>GW:</label>'+
                    '<input type="text" class="gw"><br />'+
                    '<label>Interface:</label>'+
                    '<select class="interface">' +
                    $("#"+id+" select").html() +
                    '</select><br />' );
        }

        function removeGateway(obj) {
            var id = obj.id.substring(5);
            var len = $("#netkit tr:nth-child("+(id-1+2)+") td input.route").length;
            if(len > 1) {
                $("#netkit tr:nth-child("+(id-1+2)+") td input.route").eq(len-1).prev().remove();
                $("#netkit tr:nth-child("+(id-1+2)+") td input.route").eq(len-1).remove();
                $("#netkit tr:nth-child("+(id-1+2)+") td input.gw").eq(len-1).prev().prev().remove();
                $("#netkit tr:nth-child("+(id-1+2)+") td input.gw").eq(len-1).prev().remove();
                $("#netkit tr:nth-child("+(id-1+2)+") td input.gw").eq(len-1).remove();
                $("#netkit tr:nth-child("+(id-1+2)+") td select.interface").eq(len-1).prev().prev().remove();
                $("#netkit tr:nth-child("+(id-1+2)+") td select.interface").eq(len-1).prev().remove();
                $("#netkit tr:nth-child("+(id-1+2)+") td select.interface").eq(len-1).next().remove();
                $("#netkit tr:nth-child("+(id-1+2)+") td select.interface").eq(len-1).remove();
            }
        }

        function addInterfaceId(id){
            var childs = $("#"+id+" input.eth").length;
            $("#"+id).append( '<label>eth'+childs+': </label>' +
                    '<input type="text" class="eth" />'+
                    '<label> IP/Net: </label>'+
                    '<input type="text" class="ip" />'+
                    '<label> Nome DNS Completo: </label>'+
                    '<input type="text" class="fullname" /><br />');
            $("#gw"+id+" select").append( '<option value="'+childs+'">eth'+childs+'</option>');
        }

        function removeInterface(obj) {
            var id = obj.id.substring(3);
            var len = $("#netkit tr:nth-child("+(id-1+2)+") td input.eth").length;
            if(len > 1) {
                $("#netkit tr:nth-child("+(id-1+2)+") td input.eth").eq(len-1).prev().remove();
                $("#netkit tr:nth-child("+(id-1+2)+") td input.eth").eq(len-1).remove();
                $("#netkit tr:nth-child("+(id-1+2)+") td input.ip").eq(len-1).prev().remove();
                $("#netkit tr:nth-child("+(id-1+2)+") td input.ip").eq(len-1).next().remove();
                $("#netkit tr:nth-child("+(id-1+2)+") td input.ip").eq(len-1).remove();
                $("#gw"+id+" select option:last-child").remove();
            }
        }

        function updateNs() {
            $(".nameserver").html("");
            for(var key in nameservers) {
                if(nameservers[key]!="")
                    $(".nameserver").append( '<option value="'+key+'">'+nameservers[key]+'</option>');
            }
        }

        function toggle(obj){
            var id = obj.name.substring(4);

            if(obj.value=='ns'){
                document.getElementById("dns"+id).classList.remove("hidden");

                //aggiunta nameserver all'array globale
                nameservers[id]=$("#macchina"+id).val();
            }

            if(obj.value!='ns'){
                document.getElementById("dns"+id).classList.add("hidden");

                //rimozione nameserver all'array globale
                nameservers[id]="";
            }

            // aggiornamento dropdown nameserver
            updateNs();

            if(obj.value=='ws'){
                document.getElementById("ws"+id).classList.remove("hidden");
            }

            if(obj.value!='ws'){
                document.getElementById("ws"+id).classList.add("hidden");
            }

            if(obj.value=='terminale'){
                document.getElementById("terminale"+id).classList.remove("hidden");
            }

            if(obj.value!='terminale'){
                document.getElementById("terminale"+id).classList.add("hidden");
            }
        }

        /*
        function abilitaTipo(obj){
            var id = obj.id.substring(8);
            $("#netkit tr:nth-child("+(id-1+2)+") td input[type=radio]").removeAttr( "disabled" );
        }
        */

        function nameWritten(obj){
            //abilitaTipo(obj);

            var id = obj.id.replace("macchina", "");
            var tipo = $("#netkit tr:nth-child("+ (id-1+2) +") td input[type=radio]:checked").val();
            if( tipo=="ns" )
                nameservers[id]=obj.value;
            else nameservers[id]="";

            updateNs();
        }

        function addMachine(obj) {
            var rows = $("#netkit tr").length;
            $("#netkit").append( '<tr>'+
                    '<td>'+
                    '<label for="macchina'+rows+'">Macchina '+rows+':</label>'+
                    '<input type="text" id="macchina'+rows+'" onkeyup="nameWritten(this)" /><br />'+
                    '<input type="radio" name="tipo'+rows+'" value="terminale" onclick="toggle(this)" checked> Terminale</input><br />'+
                    '<input type="radio" name="tipo'+rows+'" value="router" onclick="toggle(this)"> Router</input><br />'+
                    '<input type="radio" name="tipo'+rows+'" value="ns" onclick="toggle(this)"> Name Server</input><br />'+
                    '<input type="radio" name="tipo'+rows+'" value="ws" onclick="toggle(this)"> Web Server</input>' +
                    '<br />'+
                    '</td>'+
                    '<td class="interfaces" id="'+rows+'">'+
                    '<div id="add'+rows+'" class="btn btn-success" onclick="addInterface(this)">Aggiungi interfaccia</div> '+
                    '<div id="rem'+rows+'" class="btn btn-danger" onclick="removeInterface(this)">Rimuovi ultima interfaccia</div><br />'+
                    '</td>'+
                    '<td class="gateways" id="gw'+rows+'">'+
                    '<div id="addgw'+rows+'" class="btn btn-success" onclick="addGateway(this)">Aggiungi gateway</div> '+
                    '<div id="remgw'+rows+'" class="btn btn-danger" onclick="removeGateway(this)">Rimuovi ultimo gw</div><br />'+
                    '<label>Route:</label>'+
                    '<input type="text" class="route" /><br />'+
                    '<label>GW:</label>'+
                    '<input type="text" class="gw" /><br />'+
                    '<label>Interface:</label>'+
                    '<select class="interface">'+
                    '</select><br />'+
                    '</td>'+
                    '<td class="dns hidden" id="dns'+rows+'">'+
                    '<label>Zone (root &egrave; .):</label>'+
                    '<input type="text" class="zone" /><br />'+
                    '</td>'+
                    '<td class="ws hidden" id="ws'+rows+'">'+
                    '<input type="checkbox" name="userdir'+rows+'" value="1">Enable userdir module?</input>' +
                    '</td>'+
                    '<td class="terminale" id="terminale'+rows+'">'+
                    '<label>Nameserver di riferimento:</label>'+
                    '<select class="nameserver">' +
                    '</select>'+
                    '</td>'+
                    '</tr>');
            addInterfaceId(rows);

            updateNs();
        }

        function removeMachine(obj){
            if($("#netkit tr").length > 2) {
                $("#netkit tr:last-child").remove();

                nameservers[$("#netkit tr").length]="";
                //nb: la length e' sempre piu' lunga di 1, quindi se ho rimosso la macchina 3 ho comunque lunghezza 3
                updateNs();
            }
        }

        function download(filename, text) {
            var pom = document.createElement('a');
            var fileurl= 'data:text/plain;charset=utf-8,' + encodeURIComponent(text);
            pom.setAttribute('href', fileurl);
            pom.download = filename;

            if (!window.ActiveXObject) {
                var event = document.createEvent('MouseEvents');
                event.initMouseEvent(
                        "click", true, false, window, 0, 0, 0, 0, 0
                        , false, false, false, false, 0, null
                );
                pom.dispatchEvent(event);
                /*
                event = document.createEvent('Event');
                event.initEvent('click', true, true);
                pom.dispatchEvent(event);
                */
            }
            // for IE
            else if ( !! window.ActiveXObject && document.execCommand)     {
                var _window = window.open(fileurl, '_blank');
                _window.document.close();
                _window.document.execCommand('SaveAs', true, filename || fileurl)
                _window.close();
            }
        }


        function generateArr(obj) {

            // struttura array:
            // nome macchina ->
            //                "interfaces" ->
            //                            numero interfaccia (senza eth) ->
            //                                              "eth" -> dominio di collisione
            //                                              "ip" -> ip/mask
            //                                              "fullname" -> fullname
            //                            altro numero interfaccia -> ecc...
            //                "gateways" ->
            //                            numero gateway ->
            //                                              "route" -> ip/mask
            //                                              "gw" -> ip gateway
            //                                              "interface" -> numero interfaccia (senza eth)
            //                            altro numero gateway -> ecc...
            //                "dns" ->
            //                            "zone" -> zone name
            //                "tipo" ->    nometipo
            //                "ws" ->     "userdir" -> "1" oppure ""
            // nome seconda macchina -> ecc...

            var machines = $("#netkit tr").length-1; //NB: la prima riga contiene il titolo
            var arr=[];
            for(var i=2; i<=(machines+1); ++i){ //NB: la prima riga contiene il titolo
                var name = $("#netkit tr:nth-child("+i+") td:first-child input").val();

                //Controllo su nome macchina non vuoto (necessario per motivi di testing)
                if(name==""){
                    alert("Il campo Nome Macchina non può essere vuoto");
                    exit;
                }
                arr[name] = [];
                arr[name]["interfaces"] = [];
                arr[name]["gateways"] = [];
                arr[name]["dns"] = [];
                var interfaces = $("#netkit tr:nth-child("+i+") td.interfaces input.eth").length;
                for(var j=0; j<interfaces; ++j){
                    arr[name]["interfaces"][j] = [];
                    arr[name]["interfaces"][j]["eth"] = $("#netkit tr:nth-child("+i+") td.interfaces#"+(i-1)+" input.eth").eq(j).val();
                    arr[name]["interfaces"][j]["ip"] = $("#netkit tr:nth-child("+i+") td.interfaces#"+(i-1)+" input.ip").eq(j).val();
                    arr[name]["interfaces"][j]["fullname"] = $("#netkit tr:nth-child("+i+") td.interfaces#"+(i-1)+" input.fullname").eq(j).val();
                }
                var gateways = $("#netkit tr:nth-child("+i+") td.gateways input.route").length;
                for(var j=0; j<gateways; ++j){
                    arr[name]["gateways"][j] = [];
                    arr[name]["gateways"][j]["route"] = $("#netkit tr:nth-child("+i+") td.gateways#gw"+(i-1)+" input.route").eq(j).val();
                    arr[name]["gateways"][j]["gw"] = $("#netkit tr:nth-child("+i+") td.gateways#gw"+(i-1)+" input.gw").eq(j).val();
                    arr[name]["gateways"][j]["interface"] = $("#netkit tr:nth-child("+i+") td.gateways#gw"+(i-1)+" select.interface").eq(j).val();
                }
                arr[name]["dns"] = [];
                arr[name]["dns"]["zone"] = $("#netkit tr:nth-child("+i+") td.dns#dns"+(i-1)+" input.zone").val();
                arr[name]["tipo"] = $('input[name=tipo'+(i-1)+']:checked').val();
                arr[name]["ws"]=[];
                arr[name]["ws"]["userdir"] = $('input[name=userdir'+(i-1)+']:checked').val();
            }
            console.log(arr);
            return arr;
        }

        function generate(obj) {
            var arr = generateArr(obj);
            //console.log(arr);
            var text="";

            // conversione array in stringa html (con <br>, <hr>, <h4>, ecc) appesa a text

            text += "# Accetta il download o copia il testo seguente in un .sh e lancialo!\n"+
                    "# Ricordati di dare prima chmod +x per renderlo eseguibile!\n\n"

            text += "#! /bin/sh\n";
            text += "mkdir -p";

            //TODO cambiare con la nuova radio button
            for(var machine in arr){
                if(machine.substring(0, 2)=='ns') {
                    text += " "+machine+"/etc/bind";
                } else {
                    text += " "+machine;
                }
            }
            text += "\n";

            // generazione lab.conf
            text += "touch lab.conf\n";
            for (var machine in arr) {
                for (var interface in arr[machine]["interfaces"]){
                    text += "echo "+machine + "[" + interface + "]="+arr[machine]["interfaces"][interface]["eth"] + " >> lab.conf\n";
                }
            }

            // generazione macchina.startup
            for (var machine in arr) {
                file = machine+".startup";
                text += "touch " + file +"<br />";
                for (var interface in arr[machine]["interfaces"]){
                    //ifconfig eth_ SELFADDRESS/MASK up
                    text += "echo ifconfig eth" + interface + " " +
                            arr[machine]["interfaces"][interface]["ip"] + " up >> "+file+"\n";
                }
                for (var gateway in arr[machine]["gateways"]){
                    //route add default gw GATEWAY dev eth_
                    if(arr[machine]["gateways"][gateway]["route"]=="") {
                        text += "echo route add default gw " +
                                arr[machine]["gateways"][gateway]["gw"] + " dev eth"+
                                arr[machine]["gateways"][gateway]["interface"]+" >> " + file+"\n";
                    }
                    //route add -net NETADDRESS/MASK gw GATEADDRESS dev eth_
                    else  {
                        text += "echo route add -net " + arr[machine]["gateways"][gateway]["route"] + " gw " +
                                arr[machine]["gateways"][gateway]["gw"] + " dev eth"+
                                arr[machine]["gateways"][gateway]["interface"]+" >> " + file+"\n";
                    }
                }
                // ns
                if(arr[machine]["tipo"]=='ns') {
                    text += "echo /etc/init.d/bind start >> " + file+"\n";
                }
                // ws
                else if(arr[machine]["tipo"]=='ws') {
                    if(arr[machine]["ws"]["userdir"]=='1') {
                        text += "mkdir -p "+machine+"/home/guest/public_html\n";
                        text += "touch "+machine+"/home/guest/public_html/index.html\n";
                        text += "echo '&lt;html&gt;&lt;head&gt;&lt;title&gt;Guest Home&lt;/title&gt;&lt;/head&gt;&lt;body&gt;" +
                                "Guest Home&lt;/body&gt;&lt;/html&gt;' >> "+machine+"/home/guest/public_html/index.html\n";
                        text += "echo a2enmod userdir >> " + file+"\n";
                    }
                    text += "echo /etc/init.d/apache2 start >> " + file+"\n";
                }
                else if(arr[machine]["tipo"]=='terminale') {
                    //text += "echo a2enmod userdir >> " + file;
                    text += "mkdir -p "+machine+"/etc\n";
                    text += "touch "+machine+"/etc/resolv.conf\n";
                    text += "echo nameserver >> "+machine+"/etc/resolv.conf\n"; //TODO ip nameserver
                }
            }

            text += "rm $0\n";

            // TODO scrittura file dns. NB: basta ciclare su  machine in arr (un ns a macchina)
            var initTextArea = '<textarea style="width:100%" rows="30" readonly>';
            var endTextArea = '</textarea>';

            
            $("#solution").html(initTextArea + generaDNS(arr) + endTextArea);
            //$("#solution").html(initTextArea + text + endTextArea);

            //INIBITO IL DOWNLOAD IN FASE DI TESTING
            //download('script-netkit-' + event.timeStamp + '', text);
        }

        //TODO aggiungere spunta sulle opzioni del dns per allow recursion
        //TODO aggiungere spunta per definire se un NS è authority su qualcosa o no!
        // in caso non lo sia fargli evitare il primo for
        //NOTE: in molti casi qui si necessita dell'ip della macchina senza subnet... forse sarebbe meglio separare i campi nella generazione dell'array?
        //TODO questo algoritmo è semi-ricorsivo... per ogni macchina questa si auto-aggiunge al suo Ns di riferimento, bisogna separare il caso in cui questa è "."
        //TODO inserire menu a tendina vicino (sotto) scelta della zona così da parametrizzare quell'interfaccia 0 che io uso qui sotto

        function generaDNS(obj){
            var arr = obj;
            var text = "";
            var authority = [];
            var root;
            for (var machine in arr) {
                if(arr[machine]["tipo"]=='ns'){
                    if(arr[machine]["dns"]["zone"] == "."){
                        root = arr[machine];
                    }
                    authority[arr[machine]["dns"]["zone"]] = arr[machine];
                    text += "Nel SOA di " + arr[machine]["dns"]["zone"] + "bisogna inserire " + 
                        arr[machine]["interfaces"][0]["fullname"] + "\n"; //ho preso il nome dell'interfaccia eth0
                    text += "Nei record di " + arr[machine]["dns"]["zone"] + "bisogna inserire un record A" + 
                        arr[machine]["interfaces"][0]["fullname"] + " " + arr[machine]["interfaces"][0]["ip"] + "\n";
                }
            }


            for (var machine in arr) {
                if(arr[machine]["tipo"]=='ns'){
                    text += "Nel file db.root aggiungere il root ns come nome: " + root["interfaces"][0]["fullname"] +
                        "e ip: " + root["interfaces"][0]["ip"];
                }
            }

            for (var machine in arr) {
                for (var interface in arr[machine]["interfaces"]){
                        var ip = arr[machine]["interfaces"][interface]["ip"];
                        var nome = arr[machine]["interfaces"][interface]["fullname"]; //www.pluto.net.
                        var nomediviso = nome.split(".") //[0]www [1]pluto [2]net [3]
                        var autorita = "";
                        text += "nel nameserver ";
                        for (var i=1; i<nomediviso.length; i++){
                            autorita += nomediviso[i];
                        }
                        text += authority[autorita]+" bisogna inserire un record A per " +
                            nomediviso[0] + " assegnato all'ip " + ip + "\n";
                }
            }
            return text;
        }



    </script>
</head>
<body>
<table id="netkit" border="0" cellspacing="0" cellpadding="0">
    <tr>
        <th>Info Macchina</th>
        <th>Interfacce di Rete</th>
        <th>Gateway (Route vuoto per Default):</th>
        <th>Funzioni aggiuntive:</th>
    </tr>

</table>
<div id="add" class="btn btn-success" onclick="addMachine(this)">Aggiungi Macchina</div>
<div id="rem" class="btn btn-danger" onclick="removeMachine(this)">Rimuovi ultima Macchina</div><br />
<div id="gen" class="btn btn-primary" onclick="generate(this)"><strong>Genera rete</strong></div><br />

<h3>File generati:</h3>
<hr />
<div id="solution"></div>


<script>
    // startup
    window.onload= function() {
        addMachine(NaN);
        console.log("  _______          __   __   .__  __    \n  \\      \\   _____/  |_|  | _|__|/  |_  \n  /   |   \\_/ __ \\   __\\  |/ /  \\   __\\ \n /    |    \\  ___/|  | |    <|  ||  |   \n \\____|__  /\\___  >__| |__|_ \\__||__|   \n         \\/     \\/          \\/         ");
        console.log(" =======================================\n Good job for finding this page. Your     \n life with Netkit will be a lot easier!      \n ======================================= ");
    }
</script>
</body>
</html>
