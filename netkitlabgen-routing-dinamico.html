<!DOCTYPE html>
<html>
<head>
    <title>Netkit Lab Generator</title>
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" integrity="sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ==" crossorigin="anonymous" />
    <style>
        body {
            background: white;
            padding: 10px;
        }
        .ng-hide {
            display: none;
            visibility: hidden;
            opacity: 0;
        }
        .form-control {
            border-radius: 0;
            padding: 2px 6px;
            margin-top: -2px;
            margin-bottom: 2px;
            height: 26px;
        }
        .btn {
            margin: 2px 0;
            padding: 4px 3px;
            border-radius: 0;
        }
        .btn-square {
            height: 22px;
            width: 22px;
            padding: 0;
        }
        input {
            border-radius: 0;
            background-position: right center;
            background-repeat: no-repeat;
        }
        input:required:invalid, input:focus:invalid, textarea:required:invalid, input:invalid, textarea:invalid {
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAYAAABWdVznAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAT1JREFUeNpi/P//PwMpgImBRMACY/x7/uDX39sXt/67cMoDyOVgMjBjYFbV/8kkqcCBrIER5KS/967s+rmkXxzI5wJiRSBm/v8P7NTfHHFFl5mVdIzhGv4+u///x+xmuAlcdXPB9KeqeLgYd3bDU2ZpRRmwH4DOeAI07QXIRKipYPD35184/nn17CO4p/+cOfjl76+/X4GYAYThGn7/g+Mfh/ZZwjUA/aABpJVhpv6+dQUjZP78Z0YEK7OezS2gwltg64GmfTu6i+HL+mUMP34wgvGvL78ZOEysf8M1sGgZvQIqfA1SDAL8iUUMPIFRQLf+AmMQ4DQ0vYYSrL9vXDz2sq9LFsiX4dLRA0t8OX0SHKzi5bXf2HUMBVA0gN356N7p7xdOS3w5fAgcfNxWtn+BJi9gVVBOQfYPQIABABvRq3BwGT3OAAAAAElFTkSuQmCC');
        }
        input:required:valid, textarea:required:valid {
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAYAAABWdVznAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAZZJREFUeNpi/P//PwMpgImBRMAy58QshrNPTzP8+vOLIUInisFQyYjhz98/DB9/fmT48/+35v7H+8KNhE2+WclZd+G0gZmJmYGThUNz1fUVMZtvbWT59eUXG9wGZIWMUPj993eJ5VeWxuy8veM/CzPL3yfvH/9H0QBSBDYZyOVm4mGYfn6q4cory5lYmFh+MrEwM/76/YsR7mk2ZjbWP///WP37/y8cqIDhx58fjvtu7XV6//ndT34G/v8FasUsDjKO/+A2PP3wpGLd+TVsfOz8XH6KAT+nHpokcu7h6d9q/BoMxToVbBYqlt9///+1GO4/WVdpXqY/zMqXn13/+vTjI9mj94/y//v9/3e9ZRObvYbDT0Y2xnm///x+wsfHB3GSGLf41jb3rv0O8nbcR66d+HPvxf2/+YZFTHaqjl8YWBnm/vv37yly5LL8+vuLgYuVa3uf/4T/Kd8SnSTZpb6FGUXwcvJxbAPKP2VkZESNOBDx8+9PBm4OwR1TwmYwcfzjsBUQFLjOxs52A2YyKysrXANAgAEA7buhysQuIREAAAAASUVORK5CYII=');
        }
        input:valid, textarea:valid {
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAYAAABWdVznAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyFpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNS1jMDE0IDc5LjE1MTQ4MSwgMjAxMy8wMy8xMy0xMjowOToxNSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIChXaW5kb3dzKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpCMUU2QjQ1RjhCRUUxMUU1ODdBQUU3MUJBOUZBMDU1MyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpCMUU2QjQ2MDhCRUUxMUU1ODdBQUU3MUJBOUZBMDU1MyI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkIxRTZCNDVEOEJFRTExRTU4N0FBRTcxQkE5RkEwNTUzIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOkIxRTZCNDVFOEJFRTExRTU4N0FBRTcxQkE5RkEwNTUzIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+WXXDRQAAAWBJREFUeNqUkT9rwlAUxW/eyx8kdHByCAFLhICgKYqDa8XNJX4LJ0c/kpBF8gG0Lg62FnHQZnARuySLOojEvCS9r9DQgh288JbHOff83nlCmqZwzxC4c0TXdcHzPIiiCFqtFpTLZWCMwfl8hjiOC6vVyjIMI6pUKi//JlBKQZblwnQ6rc1mM3K5XGiWcMsQhuHDeDyuzefzVBTF1Pd9uGkghICiKDAajbTJZCJgUozXAsfNNLiBJklSxPPEUa7Xa2mxWJSOxyPj5k6nQyzLyqoUgyB4xniqqqrUbDaZ4zjqZrNJNE2DbrdLURxhCe+ZYbfbfeq6bqzX63A4HOqHw4FzMy6uVqsMU98Q6ZQh5fP5j16vt8VN8nK5TPb7fWLbtlCv10MUvyLq6ffnEv4gZPX6/f7WNE2p0WhAu91WEHGLJZww7buIPy1xUy6X8waDAW/mEVN9FAU/myVJygxfAgwAp6GboqaPmLwAAAAASUVORK5CYII=');
        }
        table {
            border-collapse: separate; border-spacing: 0 2px; box-sizing: border-box;
        }
        tr td:first-child, tr th:first-child { border-bottom-left-radius: 1px; border-top-left-radius: 1px; }
        tr td:last-child, tr th:last-child { border-bottom-right-radius: 1px; border-top-right-radius: 1px; }
        tr {
            background-color: rgba(0, 0, 0, 0.01);
        }
        td, th {
            border: solid 1px #aaa;
            border: solid 1px rgba(0, 0, 0, 0.2);
            padding: 10px;
        }
        strong {
            font-size: 120%;
            padding: 0 5px;
        }
        .hidelasthr:last-child hr {
            visibility:hidden;
            opacity:0;
            display:none;
        }
        th {
            background-color: #fafafa;
        }
        hr {
            margin: 5px 0;
            width:100%;
        }
        h1,h2,h3,h4,h5{
            width:100%;
        }
        label {
            margin-bottom: 0;
        }
        pre {outline: 1px solid #ccc; padding: 5px; border-radius: 0; width:100%; display:block }
        textarea {
            width:100%;
        }
        .string { color: green; }
        .number { color: darkorange; }
        .boolean { color: blue; }
        .null { color: magenta; }
        .key { color: red; }
        .hidden {visibility:hidden; display:none; opacity:0;}
    </style>

    <script src="js/angular.min.js"></script>
    <script>
        if (typeof(angular)=="undefined")
            document.write('<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.4.7/angular.min.js"><\/script>');
    </script>
    <script src="js/jszip.min.js"></script>
    <script>
        if (typeof(JSZip)=="undefined")
            document.write('<script src="https://raw.githubusercontent.com/Stuk/jszip/master/dist/jszip.min.js"><\/script>');
    </script>
    <script src="js/FileSaver.min.js"></script>
    <script>
        if (typeof(saveAs)=="undefined")
            document.write('<script src="https://raw.githubusercontent.com/eligrey/FileSaver.js/master/FileSaver.min.js"><\/script>');
    </script>
</head>
<body>
<h1>Netkit Lab Generator</h1>
<hr />
<div ng-app="napp" ng-controller="nc">

    <table id="netkit" border="0" cellspacing="0" cellpadding="0">
        <tr>
            <th>Info Macchina</th>
            <th>Interfacce di Rete</th>
            <th>Gateway (statico):</th>
            <th>Funzioni aggiuntive:</th>
        </tr>

        <tr data-ng-repeat="x in netkit">
            <td>
                <div><label>Macchina {{x.row}}:</label>
                    <input type="text" ng-model="x.name" class="form-control" placeholder="pc" required /></div>
                <input type="radio" value="terminale" ng-model="x.type"> Terminale</input><br />
                <input type="radio" value="router" ng-model="x.type"> Router</input><br />
                <input type="radio" value="ns" ng-model="x.type"> Name Server</input><br />
                <input type="radio" value="ws" ng-model="x.type"> Web Server</input>
                <br />
            </td>
            <td class="interfaces">
                <div class="btn btn-success" ng-click="addInterface(x)">Aggiungi interfaccia</div>
                <div class="btn btn-danger" ng-click="removeInterface(x)" ng-disabled="x.interfaces.counter<=1">Rimuovi ultima interfaccia</div><br />
                <div class="hidelasthr" data-ng-repeat="i in x.interfaces.if">
                    <div><label>Eth{{i.eth.number}}: </label>
                        <input type="text" ng-model="i.eth.domain" class="form-control" placeholder="A" required /></div>
                    <div><label> IP/Net: </label>
                        <input type="text" ng-model="i.ip" class="form-control" placeholder="0.0.0.0/0" required pattern="((^|\.)((25[0-5])|(2[0-4]\d)|(1\d\d)|([1-9]?\d))){4}/[0-9]+$" /></div>
                    <hr />
                </div>
            </td>
            <td class="gateways">
                <div class="btn btn-success" ng-click="addGateway(x)">Aggiungi gateway</div>
                <div class="btn btn-danger" ng-click="removeGateway(x)" ng-disabled="x.gateways.counter<=1">Rimuovi ultimo gw</div><br />
                <div class="hidelasthr" data-ng-repeat="j in x.gateways.gw">
                    <div><label>Route (vuoto per default gw):</label>
                        <input type="text" ng-model="j.route" class="form-control" placeholder="0.0.0.0/0" pattern="((^|\.)((25[0-5])|(2[0-4]\d)|(1\d\d)|([1-9]?\d))){4}/[0-9]+$" /></div>
                    <div><label>GW (vuoto per non generare nulla):</label>
                        <input type="text" ng-model="j.gw" class="form-control" placeholder="0.0.0.0" pattern="((^|\.)((25[0-5])|(2[0-4]\d)|(1\d\d)|([1-9]?\d))){4}$" /></div>
                    <div><label>Interface:</label>
                        <select ng-model="j.if" class="form-control">
                            <option data-ng-repeat="i in x.interfaces.if" value="{{i.eth.number}}">eth{{i.eth.number}}</option>
                        </select></div>
                    <hr />
                </div>
            </td>
            <td  ng-show="x.type=='ns'">
                <div>
                    Il supporto completo al DNS non <br />
                    &egrave; presente in questa versione.<br />
                    Verr&agrave; comunque aggiunto l'avvio<br />
                    di bind nel file di startup di <br />
                    questa macchina e creato il file <br />
                    /etc/bind/named.conf (vuoto).</div>
            </td>
            <td ng-show="x.type=='ws'">
                <input type="checkbox" value="1" ng-model="x.ws.userdir"> Enable <strong>userdir</strong> module?</input>
            </td>
            <td ng-show="x.type=='terminale'">
                <label>Nameserver di riferimento:</label>
                <select ng-model="x.pc.ns">
                    <option value=""> </option>
                    <option data-ng-repeat="m in netkit" ng-if="m.type == 'ns'" value="{{m.interfaces.if[0].ip}}">{{m.name}}</option>
                </select>
                <!-- forma piu' corretta ma non permette valore di base a meno di aggiungere un elemento vuoto all'array -->
                <!--<select ng-model="x.pc.ns"
                        ng-options="m.interfaces.if[0].ip as m.name+' '+m.interfaces.if[0].ip disable when m.type!='ns' for m in netkit"
                        class="form-control">
                </select>-->
            </td>
            <td ng-show="x.type=='router'">
                <label>Routing dinamico: </label><br /><br />
                <div><input type="checkbox" value="router" ng-model="x.routing.rip.en"> rip</input></div>
                <div ng-show="x.routing.rip.en">
                    <span class="btn btn-success btn-square" ng-click="addRipNetwork(x)">+</span>
                    <span class="btn btn-danger btn-square" ng-click="removeRipNetwork(x)" ng-disabled="x.routing.rip.network.length<=1">-</span>
                    <div data-ng-repeat="rnet in x.routing.rip.network track by $index">
                        <label>Network: </label>
                        <input type="text" placeholder="0.0.0.0/0" required pattern="((^|\.)((25[0-5])|(2[0-4]\d)|(1\d\d)|([1-9]?\d))){4}/[0-9]+$" class="form-control" ng-model="x.routing.rip.network[$index]" />
                    </div>
                    <div><label>Route (vuoto per omettere): </label>
                        <input type="text" placeholder="0.0.0.0/0" pattern="((^|\.)((25[0-5])|(2[0-4]\d)|(1\d\d)|([1-9]?\d))){4}/[0-9]+$" class="form-control" ng-model="x.routing.rip.route" /></div>
                    <div><input type="checkbox" value="ns" ng-model="x.routing.rip.connected"> redistribute connected</input></div>
                </div>
                <hr />
                <input type="checkbox" value="ns" ng-model="x.routing.ospf.en"> ospf</input><br />
                <div ng-show="x.routing.ospf.en">
                    <span class="btn btn-success btn-square" ng-click="addOspfNetwork(x)">+</span>
                    <span class="btn btn-danger btn-square" ng-click="removeOspfNetwork(x)" ng-disabled="x.routing.ospf.network.length<=1">-</span>
                    <div data-ng-repeat="onet in x.routing.ospf.network track by $index">
                        <div>
                            <label>Network: </label>
                            <input type="text" placeholder="0.0.0.0/0" required pattern="((^|\.)((25[0-5])|(2[0-4]\d)|(1\d\d)|([1-9]?\d))){4}/[0-9]+$" class="form-control" ng-model="x.routing.ospf.network[$index]" />
                        </div>
                        <label>Area: </label>
                        <input type="text" placeholder="0.0.0.0" required pattern="((^|\.)((25[0-5])|(2[0-4]\d)|(1\d\d)|([1-9]?\d))){4}$" class="form-control" ng-model="x.routing.ospf.area[$index]" />
                    </div>
                    <div><input type="checkbox" value="ns" ng-model="x.routing.ospf.connected"> redistribute connected</input></div>
                    <label>Cost: </label>
                    <div data-ng-repeat="o in x.interfaces.if">
                        <div><input type="text" placeholder="0" class="form-control" ng-model="x.routing.ospf.if[o.eth.number].cost" pattern="[0-9]*" /></div>
                        <select ng-model="x.routing.ospf.if[o.eth.number].interface" class="form-control" style="margin-bottom: 4px;">
                            <option data-ng-repeat="i in x.interfaces.if" value="{{i.eth.number}}">eth{{i.eth.number}}</option>
                        </select>
                    </div>
                </div>
            </td>
        </tr>

    </table>
    <div class="btn btn-success" ng-click="addMachine()">Aggiungi Macchina</div>
    <div class="btn btn-danger" ng-click="removeMachine()" ng-disabled="counter<=1">Rimuovi ultima Macchina</div><br />
    <a class="btn btn-primary" download="script.netkit" href="{{ makeDownload(generateScript(netkit)) }}"><strong>Scarica il file .sh</strong></a>
    <a class="btn btn-primary" ng-click="generateZip(netkit)"><strong>Scarica il file .zip</strong></a>

    <br />
    <br />
    <hr />
    <br />

    <h4>Anteprima:</h4>
    <textarea rows="15" readonly>{{ generateScript(netkit) }}</textarea>

    <div class="btn btn-success" onclick="debug()">Debug (non in tempo reale)</div>
    <div id="origin" class="hidden">{{netkit}}</div>
    <pre id="highlight"></pre>

</div>


<script>
    if (typeof JSON.clone !== "function") {
        JSON.clone = function(obj) {
            return JSON.parse(JSON.stringify(obj));
        };
    }

    function highlight(json) {
        if (typeof json != 'string') {
            json = JSON.stringify(json, undefined, 4);
        }
        else {
            json = JSON.stringify(JSON.parse(json), undefined, 4);
        }
        json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
            var cls = 'number';
            if (/^"/.test(match)) {
                if (/:$/.test(match)) {
                    cls = 'key';
                } else {
                    cls = 'string';
                }
            } else if (/true|false/.test(match)) {
                cls = 'boolean';
            } else if (/null/.test(match)) {
                cls = 'null';
            }
            return '<span class="' + cls + '">' + match + '</span>';
        });
    }

    function debug() {
        var json = document.getElementById("origin").innerHTML;
        document.getElementById("highlight").innerHTML=highlight(json);
    }

    function makeFileStructure(nk){
        var lab = [];
        lab["folder"] = [];
        lab["file"] = [];
        lab["warning"] = 0;
        lab["error"] = 0;

        for(var mindex in nk){
            if(nk[mindex].name.substring(0, 2)=='ns') {
                lab["folder"][nk[mindex].name+"/etc/bind"]="";
            } else {
                lab["folder"][nk[mindex].name]="";
            }
        }

        // generazione lab.conf
        lab["file"]["lab.conf"]="";
        for (var mindex in nk) {
            for (var i in nk[mindex].interfaces.if){
                lab["file"]["lab.conf"] += nk[mindex].name + "[" + nk[mindex].interfaces.if[i].eth.number + "]="+nk[mindex].interfaces.if[i].eth.domain + "\n";
            }
        }

        // generazione macchina.startup
        for (var mindex in nk) {
            lab["file"][nk[mindex].name+".startup"]="";

            for (var i in nk[mindex].interfaces.if){
                //ifconfig eth_ SELFADDRESS/MASK up
                lab["file"][nk[mindex].name+".startup"] += "ifconfig eth" + nk[mindex].interfaces.if[i].eth.number +
                        " " + nk[mindex].interfaces.if[i].ip + " up\n";
            }

            for (var g in nk[mindex].gateways.gw) {
                if (typeof(nk[mindex].gateways.gw[g].gw) != "undefined" && nk[mindex].gateways.gw[g].gw != "") {
                    //route add default gw GATEWAY dev eth_
                    if (nk[mindex].gateways.gw[g].route == "") {
                        lab["file"][nk[mindex].name+".startup"] += "route add default gw " +
                                nk[mindex].gateways.gw[g].gw + " dev eth" +
                                nk[mindex].gateways.gw[g].if + "\n";
                    }
                    //route add -net NETADDRESS/MASK gw GATEADDRESS dev eth_
                    else {
                        lab["file"][nk[mindex].name+".startup"] += "route add -net " + nk[mindex].gateways.gw[g].route + " gw " +
                                nk[mindex].gateways.gw[g].gw + " dev eth" +
                                nk[mindex].gateways.gw[g].if + "\n";
                    }
                }
            }

            // ns
            if(nk[mindex].type=='ns') {
                lab["file"][nk[mindex].name+".startup"] += "/etc/init.d/bind start\n";
                lab["folder"][nk[mindex].name+"/etc/bind"]="";
                lab["file"][nk[mindex].name+"/etc/bind/named.conf"]="";
            }
            // ws
            else if(nk[mindex].type=='ws') {
                if(nk[mindex].ws.userdir==true) {
                    lab["folder"][nk[mindex].name+"/home/guest/public_html"]="";
                    lab["file"][nk[mindex].name+"/home/guest/public_html/index.html"]='<html><head><title>Guest Home</title></head><body>Guest Home</body></html>';
                    lab["file"][nk[mindex].name+".startup"] += "a2enmod userdir\n";
                }
                lab["file"][nk[mindex].name+".startup"] += "/etc/init.d/apache2 start\n";
            }
            else if(nk[mindex].type=='terminale') {
                if(typeof(nk[mindex].pc.ns) != "undefined" && nk[mindex].pc.ns != "") {
                    lab["folder"][nk[mindex].name + "/etc"] = "";
                    lab["file"][nk[mindex].name + "/etc/resolv.conf"] = "nameserver " + nk[mindex].pc.ns.split("/")[0] + "\n";

                    lab["warning"] = 1;
                }
            }
        }
        for (var mindex in nk) {
            if(nk[mindex].routing.rip.en || nk[mindex].routing.ospf.en){
                lab["file"][nk[mindex].name+".startup"] += "/etc/init.d/zebra start\n";
                lab["folder"][nk[mindex].name+"/etc/zebra"] = "";
                lab["file"][nk[mindex].name+"/etc/zebra/daemons"] = "zebra=yes\n";
            }
            if(nk[mindex].routing.rip.en){
                lab["file"][nk[mindex].name+"/etc/zebra/daemons"] += "ripd=yes\n";
                lab["file"][nk[mindex].name+"/etc/zebra/ripd.conf"] = "";
                lab["file"][nk[mindex].name+"/etc/zebra/ripd.conf"] += "router rip\n";

                for(var n in nk[mindex].routing.rip.network)
                    lab["file"][nk[mindex].name+"/etc/zebra/ripd.conf"] += "network "+nk[mindex].routing.rip.network[n]+"\n";

                if (typeof(nk[mindex].routing.rip.route) != "undefined" && nk[mindex].routing.rip.route != "")
                    lab["file"][nk[mindex].name + "/etc/zebra/ripd.conf"] += "route " + nk[mindex].routing.rip.route + "\n";

                lab["file"][nk[mindex].name + "/etc/zebra/ripd.conf"] += "\n";
            }

            if(nk[mindex].routing.ospf.en){
                lab["file"][nk[mindex].name+"/etc/zebra/daemons"] += "ospfd=yes\n";
                lab["file"][nk[mindex].name+"/etc/zebra/ospfd.conf"] = "";
                lab["file"][nk[mindex].name+"/etc/zebra/ospfd.conf"] += "router ospf\n";

                for(var m in nk[mindex].routing.ospf.network)
                    lab["file"][nk[mindex].name+"/etc/zebra/ospfd.conf"] += "network " + nk[mindex].routing.ospf.network[m] + " area " + nk[mindex].routing.ospf.area[m] + "\n"; // TODO potrebbero esserci più network

                lab["file"][nk[mindex].name+"/etc/zebra/ospfd.conf"] += "\n";
            }

            //nb: mantenere l'ordine
            if(nk[mindex].routing.rip.en && nk[mindex].routing.rip.connected){
                lab["file"][nk[mindex].name+"/etc/zebra/ripd.conf"] += "redistribute connected\n";
            }
            if(nk[mindex].routing.ospf.en && nk[mindex].routing.ospf.connected){
                lab["file"][nk[mindex].name+"/etc/zebra/ospfd.conf"] += "redistribute connected\n";
            }
            if(nk[mindex].routing.rip.en && nk[mindex].routing.ospf.en){
                lab["file"][nk[mindex].name+"/etc/zebra/ripd.conf"] += "redistribute ospf\n";
                lab["file"][nk[mindex].name+"/etc/zebra/ospfd.conf"] += "redistribute rip\n";
            }

            //nb: i costi vanno qui alla fine
            if(nk[mindex].routing.ospf.en) {
                for (var face in nk[mindex].routing.ospf.if) {
                    if (nk[mindex].routing.ospf.if[face].cost != "" && typeof(nk[mindex].routing.ospf.if[face].cost) != "undefined") {
                        lab["file"][nk[mindex].name + "/etc/zebra/ospfd.conf"] += "interface eth" + nk[mindex].routing.ospf.if[face].interface + "\n";
                        lab["file"][nk[mindex].name + "/etc/zebra/ospfd.conf"] += "ospf cost " + nk[mindex].routing.ospf.if[face].cost + "\n";
                    }
                }
            }

        }
        return lab;
    }

    function makeScript(lab){
        var text="";

        text += "# Ricordati di usare prima 'chmod +x' (o 'chmod 500') sullo script per renderlo eseguibile. Lo script si autodistrugge al termine\n";
        if(lab["warning"] == 1) {
            text += "# ATTENZIONE: l'ip scelto per il nameserver in nella cartella /etc/resolv.conf di un terminale potrebbe essere errato se il ns non ha una sola interfaccia\n";
        }

        text += "\n";

        text += "#! /bin/sh\n";

        for(var folderName in lab["folder"]){
            text += "mkdir -p " + folderName + "\n";
        }
        for(var fileName in lab["file"]){
            text += "touch " + fileName + "\n";
            var lines = lab["file"][fileName].split("\n");
            for(var lineIndex in lines) {
                text += "echo '" + lines[lineIndex] + "' >> " + fileName + "\n";
            }
        }

        text += "rm $0\n";

        return text;
    }

    function makeZip(lab){
        var zip = new JSZip();

        for(var folderName in lab["folder"]){
            zip.folder(folderName);
        }
        for(var fileName in lab["file"]){
            zip.file(fileName, lab["file"][fileName]);
        }
        var content = zip.generate({type:"blob"});
        if(lab["warning"] == 1) {
            alert("ATTENZIONE: l'ip scelto per il nameserver in nella cartella /etc/resolv.conf di un terminale potrebbe essere errato se il ns non ha una sola interfaccia");
        }

        saveAs(content, "lab.zip");
    }

    var app = angular.module('napp', []);
    app.config(['$compileProvider',
        function ($compileProvider) {
            $compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|local|data):/);
        }
    ]);
    app.controller('nc', function($scope) {

        var backbone = {
            "name":"",
            "row":1,
            "type":"router",
            "interfaces":{"counter":1, "if":[{"eth":{"number":0}, "ip":""}]},
            "gateways":{"counter":1, "gw":[{"route":"", "if":0}]},
            "pc":{"ns":""},
            "ws":{"userdir":false},
            "routing":{
                "rip":{"en":false, "connected":true, "network":[""]},
                "ospf":{"en":false, "connected":true, "if":[], "network":[""], "area":[""]}
            }
        };

        $scope.netkit = [JSON.clone(backbone)];

        $scope.counter = 1;
        $scope.addMachine = function() {
            $scope.counter++;
            var p = JSON.clone(backbone);
            p.row=$scope.counter;
            $scope.netkit.push(p);
        };
        $scope.removeMachine = function() {
            if($scope.counter>1 && confirm("Sicuro di voler rimuovere la macchina?")) {
                $scope.netkit.pop();
                $scope.counter--;
            }
        };
        $scope.addInterface = function(machine) {
            machine.interfaces.if.push({"eth":{"number":machine.interfaces.counter}});
            machine.interfaces.counter++;
        };
        $scope.removeInterface = function(machine) {
            if(machine.interfaces.counter>1 && confirm("Sicuro di voler rimuovere l'interfaccia?")) {
                machine.interfaces.if.pop();
                machine.interfaces.counter--;
            }
        };
        $scope.addGateway = function(machine) {
            machine.gateways.counter++;
            machine.gateways.gw.push({"route":"", "if":0});
        };
        $scope.removeGateway = function(machine) {
            if(machine.gateways.counter>1 && confirm("Sicuro di voler rimuovere il gateway?")) {
                machine.gateways.gw.pop();
                machine.gateways.counter--;
            }
        };
        $scope.addRipNetwork = function(machine) {
            machine.routing.rip.network.push("");
        };
        $scope.removeRipNetwork = function(machine) {
            if(machine.routing.rip.network.length>1 && confirm("Sicuro di voler rimuovere il network?")) {
                machine.routing.rip.network.pop();
            }
        };
        $scope.addOspfNetwork = function(machine) {
            machine.routing.ospf.network.push("");
            machine.routing.ospf.area.push("");
        };
        $scope.removeOspfNetwork = function(machine) {
            if(machine.routing.ospf.network.length>1 && confirm("Sicuro di voler rimuovere il network?")) {
                machine.routing.ospf.network.pop();
                machine.routing.ospf.area.pop();
            }
        };

        $scope.makeDownload = function(text) {
            return 'data:text/plain;charset=utf-8,' + encodeURIComponent(text);
        };

        $scope.generateScript = function(nk) {
            return makeScript(makeFileStructure(nk));
        };

        $scope.generateZip = function(nk) {
            return makeZip(makeFileStructure(nk));
        };
    });

    // startup
    window.onload= function() {
        console.log("  _______          __   __   .__  __    \n  \\      \\   _____/  |_|  | _|__|/  |_  \n  /   |   \\_/ __ \\   __\\  |/ /  \\   __\\ \n /    |    \\  ___/|  | |    <|  ||  |   \n \\____|__  /\\___  >__| |__|_ \\__||__|   \n         \\/     \\/          \\/         ");
        console.log(" =======================================\n Good job for finding this page. Your     \n life with Netkit will be a lot easier!      \n ======================================= ");
    }

</script>

</body>
</html>