<!DOCTYPE html>
<html>
<head>
    <title>Netkit Lab Generator</title>
<link rel="stylesheet" href="css/bootstrap.min.css" />
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" integrity="sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ==" crossorigin="anonymous" />
<style>
    body {
        background: white;
        padding: 10px;
    }
    .ng-hide {
        display: none;
        visibility: hidden;
        opacity: 0;
    }
    .btn {
        margin: 2px 0;
        padding: 4px 3px;
        border-radius: 0;
    }
    input {
        border-radius: 0;
    }
    table {
        border-collapse: separate; border-spacing: 0 2px; box-sizing: border-box;
    }
    tr td:first-child, tr th:first-child { border-bottom-left-radius: 1px; border-top-left-radius: 1px; }
    tr td:last-child, tr th:last-child { border-bottom-right-radius: 1px; border-top-right-radius: 1px; }
    tr {
        background-color: rgba(0, 0, 0, 0.01);
    }
    td, th {
        border: solid 1px #aaa;
        border: solid 1px rgba(0, 0, 0, 0.2);
        padding: 10px;
    }
    strong {
        font-size: 120%;
        padding: 0 5px;
    }
</style>

<script src="js/angular.min.js"></script>
<script>
    if (typeof(angular)=="undefined")
        document.write('<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.4.7/angular.min.js"><\/script>');
</script>
</head>
<body>
<h1>Netkit Lab Generator</h1>
<hr />
<div ng-app="napp" ng-controller="nc">

    <table id="netkit" border="0" cellspacing="0" cellpadding="0">
        <tr>
            <th>Info Macchina</th>
            <th>Interfacce di Rete</th>
            <th>Gateway (Route vuoto per Default):</th>
            <th>Funzioni aggiuntive:</th>
        </tr>

        <tr data-ng-repeat="x in netkit">
            <td>
                <label>Macchina {{x.row}}:</label>
                <input type="text" ng-model="x.name" placeholder="pc" /><br />
                <input type="radio" value="terminale" ng-model="x.type"> Terminale</input><br />
                <input type="radio" value="router" ng-model="x.type"> Router</input><br />
                <input type="radio" value="ns" ng-model="x.type"> Name Server</input><br />
                <input type="radio" value="ws" ng-model="x.type"> Web Server</input>
                <br />
            </td>
            <td class="interfaces">
                <div class="btn btn-success" ng-click="addInterface(x)">Aggiungi interfaccia</div>
                <div class="btn btn-danger" ng-click="removeInterface(x)" ng-disabled="x.interfaces.counter<=1">Rimuovi ultima interfaccia</div><br />
                <div data-ng-repeat="i in x.interfaces.if">
                    <label>Eth{{i.eth.number}}: </label>
                    <input type="text" ng-model="i.eth.domain" placeholder="A" /><br />
                    <label> IP/Net: </label>
                    <input type="text" ng-model="i.ip" placeholder="0.0.0.0/0" />
                </div>
            </td>
            <td class="gateways">
                <div class="btn btn-success" ng-click="addGateway(x)">Aggiungi gateway</div>
                <div class="btn btn-danger" ng-click="removeGateway(x)" ng-disabled="x.gateways.counter<=1">Rimuovi ultimo gw</div><br />
                <div data-ng-repeat="j in x.gateways.gw">
                    <label>Route:</label>
                    <input type="text" ng-model="j.route" placeholder="0.0.0.0/0" /><br />
                    <label>GW:</label>
                    <input type="text" ng-model="j.gw" placeholder="0.0.0.0" /><br />
                    <label>Interface:</label>
                    <select ng-model="j.if">
                        <option data-ng-repeat="i in x.interfaces.if" value="{{i.eth.number}}">eth{{i.eth.number}}</option>
                    </select>
                </div>
            </td>
            <td  ng-show="x.type=='ns'"></td>
            <td ng-show="x.type=='ws'">
                <input type="checkbox" value="1" ng-model="x.ws.userdir">Enable userdir module?</input>
            </td>
            <td ng-show="x.type=='terminale'">
                <label>Nameserver di riferimento:</label>
                <!-- tecnica funzionante ma meno elegante -->
                <!-- <select ng-model="x.pc.ns">
                    <option data-ng-repeat="m in netkit" ng-if="m.type == 'ns'" value="{{m.interfaces.if[0].ip}}">{{m.name}}</option>
                </select>-->
                <select ng-model="x.pc.ns"
                        ng-options="m.interfaces.if[0].ip as m.name+' '+m.interfaces.if[0].ip disable when m.type!='ns' for m in netkit">
                </select>
            </td>
            <td ng-show="x.type=='router'">
                <input type="checkbox" value="router" ng-model="x.routing.rip.en"> rip</input><br />
                <div ng-show="x.routing.rip.en">
                    <label>Network: </label><input type="text" placeholder="0.0.0.0/0" ng-model="x.routing.rip.network" />
                </div>
                <input type="checkbox" value="ns" ng-model="x.routing.ospf.en"> ospf</input><br />
                <div ng-show="x.routing.ospf.en">
                    <label>Network: </label><input type="text" placeholder="0.0.0.0/0" ng-model="x.routing.ospf.network" /><br />
                    <label>Area: </label><input type="text" placeholder="0.0.0.0" ng-model="x.routing.ospf.area" /><br />
                    <label>Cost: </label><input type="text" placeholder="0" ng-model="x.routing.ospf.cost" /><br />
                    <select ng-model="x.routing.ospf.interface">
                        <option data-ng-repeat="i in x.interfaces.if" value="{{i.eth.number}}">eth{{i.eth.number}}</option>
                    </select>
                </div>
            </td>
        </tr>

    </table>
    <div class="btn btn-success" ng-click="addMachine()">Aggiungi Macchina</div>
    <div class="btn btn-danger" ng-click="removeMachine()" ng-disabled="counter<=1">Rimuovi ultima Macchina</div><br />
    <a class="btn btn-primary" download="script.netkit" href="{{ makedownload(generate(netkit)) }}"><strong>Scarica il file .sh</strong></a><br /><br />

    <hr />

    <h4>Anteprima:</h4>
    <textarea style="width:100%" rows="30" readonly>{{ generate(netkit) }}</textarea>

</div>


<script>
    if (typeof JSON.clone !== "function") {
        JSON.clone = function(obj) {
            return JSON.parse(JSON.stringify(obj));
        };
    }

    var app = angular.module('napp', []);
    app.config(['$compileProvider',
        function ($compileProvider) {
            $compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|local|data):/);
        }
    ]);
    app.controller('nc', function($scope) {

        var backbone = {
            "name":"",
            "row":1,
            "type":"terminale",
            "interfaces":{"counter":1, "if":[{"eth":{"number":0}, "ip":""}]},
            "gateways":{"counter":1, "gw":[{"route":"", "if":0}]},
            "pc":{"ns":""},
            "ws":{"userdir":false},
            "routing":{"rip":{"en":false}, "ospf":{"en":false}}
        };

        $scope.netkit = [JSON.clone(backbone)];

        $scope.counter = 1;
        $scope.addMachine = function() {
            $scope.counter++;
            var p = JSON.clone(backbone);
            p.row=$scope.counter;
            $scope.netkit.push(p);
        };
        $scope.removeMachine = function() {
            if($scope.counter>1 && confirm("Sicuro di voler rimuovere la macchina?")) {
                $scope.netkit.pop();
                $scope.counter--;
            }
        };
        $scope.addInterface = function(machine) {
            machine.interfaces.if.push({"eth":{"number":machine.interfaces.counter}});
            machine.interfaces.counter++;
        };
        $scope.removeInterface = function(machine) {
            if(machine.interfaces.counter>1 && confirm("Sicuro di voler rimuovere l'interfaccia?")) {
                machine.interfaces.if.pop();
                machine.interfaces.counter--;
            }
        };
        $scope.addGateway = function(machine) {
            machine.gateways.counter++;
            machine.gateways.gw.push({"route":"", "if":0});
        };
        $scope.removeGateway = function(machine) {
            if(machine.gateways.counter>1 && confirm("Sicuro di voler rimuovere il gateway?")) {
                machine.gateways.gw.pop();
                machine.gateways.counter--;
            }
        };

        $scope.makedownload = function(text) {
            return 'data:text/plain;charset=utf-8,' + encodeURIComponent(text);
        };

        $scope.generate = function(nk) {
            var text="";

            // conversione array in stringa html (con <br>, <hr>, <h4>, ecc) appesa a text

            text += "# Ricordati di usare prima chmod +x sullo script per renderlo eseguibile e che lo script si autodistrugge al termine\n\n";

            text += "#! /bin/sh\n";
            text += "mkdir -p";

            for(var mindex in nk){
                if(nk[mindex].name.substring(0, 2)=='ns') {
                    text += " "+nk[mindex].name+"/etc/bind";
                } else {
                    text += " "+nk[mindex].name;
                }
            }
            text += "\n";

            // generazione lab.conf
            text += "touch lab.conf\n";
            for (var mindex in nk) {
                for (var i in nk[mindex].interfaces.if){
                    text += "echo "+nk[mindex].name + "[" + nk[mindex].interfaces.if[i].eth.number + "]="+nk[mindex].interfaces.if[i].eth.domain + " >> lab.conf\n";
                }
            }

            // generazione macchina.startup
            for (var mindex in nk) {
                file = nk[mindex].name+".startup";
                text += "touch " + file +"\n";
                for (var i in nk[mindex].interfaces.if){
                    //ifconfig eth_ SELFADDRESS/MASK up
                    text += "echo ifconfig eth" + nk[mindex].interfaces.if[i].eth.number + " " +
                            nk[mindex].interfaces.if[i].ip + " up >> "+file+"\n";
                }
                if(!(nk[mindex].type=='router' && (nk[mindex].routing.rip.en || nk[mindex].routing.ospf.en))) {
                    for (var g in nk[mindex].gateways.gw) {
                        //route add default gw GATEWAY dev eth_
                        if (nk[mindex].gateways.gw[g].route == "") {
                            text += "echo route add default gw " +
                                    nk[mindex].gateways.gw[g].gw + " dev eth" +
                                    nk[mindex].gateways.gw[g].if + " >> " + file + "\n";
                        }
                        //route add -net NETADDRESS/MASK gw GATEADDRESS dev eth_
                        else {
                            text += "echo route add -net " + nk[mindex].gateways.gw[g].route + " gw " +
                                    nk[mindex].gateways.gw[g].gw + " dev eth" +
                                    nk[mindex].gateways.gw[g].if + " >> " + file + "\n";
                        }
                    }
                }
                // ns
                if(nk[mindex].type=='ns') {
                    text += "echo /etc/init.d/bind start >> " + file+"\n";
                }
                // ws
                else if(nk[mindex].type=='ws') {
                    if(nk[mindex].ws.userdir==true) {
                        text += "mkdir -p "+nk[mindex].name+"/home/guest/public_html\n";
                        text += "touch "+nk[mindex].name+"/home/guest/public_html/index.html\n";
                        text += "echo '<html><head><title>Guest Home</title></head><body>Guest Home</body></html>' >> "+nk[mindex].name+"/home/guest/public_html/index.html\n";
                        text += "echo a2enmod userdir >> " + file+"\n";
                    }
                    text += "echo /etc/init.d/apache2 start >> " + file+"\n";
                }
                else if(nk[mindex].type=='terminale') {
                    text += "mkdir -p "+nk[mindex].name+"/etc\n";
                    text += "touch "+nk[mindex].name+"/etc/resolv.conf\n";
                    text += "#ATTENZIONE: l'ip scelto per il nameserver in "+nk[mindex].name+"/etc/resolv.conf potrebbe essere errato se il ns non ha una sola interfaccia\n"
                    text += "echo nameserver " + nk[mindex].pc.ns.split("/")[0] + " >> "+nk[mindex].name+"/etc/resolv.conf\n"; //TODO ip nameserver (si puo' ricavare correttamente?)
                }
            }

            //TODO testing
            for (var mindex in nk) {
                if(nk[mindex].routing.rip.en || nk[mindex].routing.ospf.en){
                    text += "echo /etc/init.d/zebra start >> " + file+"\n";
                    text += "mkdir -p "+nk[mindex].name+"/etc/zebra\n";
                    text += "echo 'zebra=yes' >> "+nk[mindex].name+"/etc/zebra/daemons\n";
                }
                if(nk[mindex].routing.rip.en){
                    text += "echo 'ripd=yes' >> "+nk[mindex].name+"/etc/zebra/daemons\n";
                    text += "echo 'router rip' >> "+nk[mindex].name+"/etc/zebra/ripd.conf\n";
                    text += "echo 'network "+nk[mindex].routing.rip.network+"' >> "+nk[mindex].name+"/etc/zebra/ripd.conf\n";
                }
                if(nk[mindex].routing.ospf.en){
                    text += "echo 'ospfd=yes' >> "+nk[mindex].name+"/etc/zebra/daemons\n";
                    text += "echo 'interface eth"+nk[mindex].routing.ospf.interface+"' >> "+nk[mindex].name+"/etc/zebra/ospfd.conf\n";
                    text += "echo 'ospf cost "+nk[mindex].routing.ospf.cost+"' >> "+nk[mindex].name+"/etc/zebra/ospfd.conf\n";
                    text += "echo 'router ospf' >> "+nk[mindex].name+"/etc/zebra/ospfd.conf\n";
                    text += "echo 'network "+nk[mindex].routing.ospf.network+" area "+nk[mindex].routing.ospf.area+"' >> "+nk[mindex].name+"/etc/zebra/ospfd.conf\n";
                }
                if(nk[mindex].routing.rip.en && nk[mindex].routing.ospf.en){
                    text += "echo 'redistribute ospf' >> "+nk[mindex].name+"/etc/zebra/ripd.conf\n";
                    text += "echo 'redistribute connected' >> "+nk[mindex].name+"/etc/zebra/ripd.conf\n";
                    text += "echo 'redistribute rip' >> "+nk[mindex].name+"/etc/zebra/ospfd.conf\n";
                    text += "echo 'redistribute connected' >> "+nk[mindex].name+"/etc/zebra/ospfd.conf\n";
                }
            }


            text += "rm $0\n";

            return text;

        };
    });

    // startup
    window.onload= function() {
        console.log("  _______          __   __   .__  __    \n  \\      \\   _____/  |_|  | _|__|/  |_  \n  /   |   \\_/ __ \\   __\\  |/ /  \\   __\\ \n /    |    \\  ___/|  | |    <|  ||  |   \n \\____|__  /\\___  >__| |__|_ \\__||__|   \n         \\/     \\/          \\/         ");
        console.log(" =======================================\n Good job for finding this page. Your     \n life with Netkit will be a lot easier!      \n ======================================= ");
    }

</script>

</body>
</html>